name: 'Run Test'

on:
  workflow_call:
    secrets:
      SLACK_WEBHOOK_URL:
        required: true
    workflow_dispatch:

  push:
    branches:
      - 'master'
      - 'dev'
    paths:
      - 'modules/aws/sonar-upgrader/**'
      - 'examples/sonar_upgrade/*'

  pull_request:
    types:
      - 'opened'
      - 'reopened'
    branches:
      - 'master'
      - 'dev'
    paths:
      - 'modules/aws/sonar-upgrader/**'
      - 'examples/sonar_upgrade/*'

permissions:
  contents: read

jobs:
  unit-tests:
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Sonar Upgrade unit tests

    name: '${{ matrix.name }}'
    runs-on: ubuntu-latest
    env:
      PYTHON_UPGRADER_DIR: ./modules/aws/sonar-upgrader/python_upgrader
    environment: test

    # Use the Bash shell regardless whether the GitHub Actions runner is ubuntu-latest, macos-latest, or windows-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Pick ref
        run: |
          if [ -z "${{ inputs.explicit_ref }}" ]; then
            echo REF=${{ github.ref }} >> $GITHUB_ENV;
          else
            echo REF=${{ inputs.explicit_ref }} >> $GITHUB_ENV;
          fi
